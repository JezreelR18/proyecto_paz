CREATE TABLE users (
    id_user INT AUTO_INCREMENT PRIMARY KEY,
    fullname VARCHAR(100) NOT NULL,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    role VARCHAR(50) NOT NULL,
    is_signed BOOLEAN DEFAULT FALSE,
    enable BOOLEAN DEFAULT TRUE,
    date_of_register TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


CREATE TABLE resources (
    id_resource INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    type_resource VARCHAR(50) NOT NULL,
    url VARCHAR(500) NOT NULL,
    description TEXT,
    id_user_register INT, -- Nombre corregido
    date_of_register TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_user_register) REFERENCES users(id_user) ON DELETE SET NULL
);


CREATE TABLE comments (
    id_comment INT AUTO_INCREMENT PRIMARY KEY,
    comment TEXT NOT NULL,
    level_monitoring VARCHAR(20) NOT NULL,
    id_user_register INT, -- Nombre corregido
    date_of_register TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_user_register) REFERENCES users(id_user) ON DELETE SET NULL
);


CREATE TABLE questionnaires (
    id_questionnaire INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    category ENUM('emotional_state', 'stress_level', 'conflict_tendencies', 'general_wellbeing') NOT NULL,
    total_questions INT DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);


CREATE TABLE questions (
    id_question INT AUTO_INCREMENT PRIMARY KEY,
    id_questionnaire INT NOT NULL,
    question_text TEXT NOT NULL,
    question_type ENUM('multiple_choice', 'likert_scale', 'open_ended') DEFAULT 'likert_scale',
    options JSON,
    weight DECIMAL(3,2) DEFAULT 1.00,
    question_order INT NOT NULL,
    dimension ENUM('emotional', 'stress', 'conflict', 'self_awareness') NOT NULL,
    FOREIGN KEY (id_questionnaire) REFERENCES questionnaires(id_questionnaire) ON DELETE CASCADE,
    INDEX idx_questionnaire (id_questionnaire),
    INDEX idx_question_order (question_order)
);


CREATE TABLE user_answers (
    id_user_answer INT AUTO_INCREMENT PRIMARY KEY,
    id_user INT NOT NULL,
    id_question INT NOT NULL,
    id_questionnaire INT NOT NULL,
    answer_value TEXT NOT NULL,
    answered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_user) REFERENCES users(id_user) ON DELETE CASCADE, -- Corregido
    FOREIGN KEY (id_question) REFERENCES questions(id_question) ON DELETE CASCADE,
    FOREIGN KEY (id_questionnaire) REFERENCES questionnaires(id_questionnaire) ON DELETE CASCADE,
    INDEX idx_user_questionnaire (id_user, id_questionnaire),
    INDEX idx_user_question (id_user, id_question)
);


CREATE TABLE assessment_results (
    id_result INT AUTO_INCREMENT PRIMARY KEY,
    id_user INT NOT NULL,
    id_questionnaire INT NOT NULL,
    total_score DECIMAL(5,2) NOT NULL,
    emotional_score DECIMAL(5,2),
    stress_score DECIMAL(5,2),
    conflict_score DECIMAL(5,2),
    self_awareness_score DECIMAL(5,2),
    mental_state_category ENUM('excelente', 'bueno', 'regular', 'necesita_mejora', 'preocupante') NOT NULL,
    recommendations TEXT,
    completed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    duration_minutes INT,
    FOREIGN KEY (id_user) REFERENCES users(id_user) ON DELETE CASCADE, -- Corregido
    FOREIGN KEY (id_questionnaire) REFERENCES questionnaires(id_questionnaire) ON DELETE CASCADE,
    INDEX idx_user_results (id_user),
    INDEX idx_questionnaire_results (id_questionnaire),
    INDEX idx_completion_date (completed_at)
);


CREATE TABLE result_recommendations (
    id_recommendation INT AUTO_INCREMENT PRIMARY KEY,
    id_result INT NOT NULL,
    id_resource INT NOT NULL, -- Corregido
    recommendation_reason TEXT,
    priority_level INT DEFAULT 1,
    FOREIGN KEY (id_result) REFERENCES assessment_results(id_result) ON DELETE CASCADE,
    FOREIGN KEY (id_resource) REFERENCES resources(id_resource) ON DELETE CASCADE, -- Corregido
    INDEX idx_result_recommendations (id_result)
);


CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_resources_user_register ON resources(id_user_register);
CREATE INDEX idx_comments_user_register ON comments(id_user_register);


SHOW TABLES;

INSERT INTO users 
  (id_user, fullname, username, password, email, role, is_signed, enable)
VALUES
  (1, 'Sistema', 'system',
   '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', -- bcrypt de "password"
   'system@local', 'system', 1, 1)
ON DUPLICATE KEY UPDATE
  fullname = VALUES(fullname),
  username = VALUES(username),
  email    = VALUES(email),
  role     = VALUES(role),
  is_signed= VALUES(is_signed),
  enable   = VALUES(enable);

INSERT INTO resources 
(title, type_resource, url, description, id_user_register)
VALUES
('Meditación guiada: Calma y Presencia',
 'meditation',
 'https://open.spotify.com/episode/3fCGuidaCalmaPresencia',
 'Una meditación corta de 10 minutos para reconectar con el presente y soltar la tensión acumulada.',
 1),

('Podcast: Estrés y cómo regularlo con la respiración consciente',
 'podcast',
 'https://open.spotify.com/episode/estrés-respiracion',
 'Episodio educativo que explica cómo el ritmo de la respiración puede transformar tu respuesta al estrés cotidiano.',
 1),

('Artículo: La práctica de la autocompasión',
 'article',
 'https://www.mindful.org/es/la-practica-de-la-autocompasion/',
 'Lectura breve que enseña a reemplazar la autocrítica por comprensión y amabilidad hacia uno mismo.',
 1),

('Guía práctica: Comunicación no violenta',
 'guide',
 'https://www.cnvcolombia.org/guias/comunicacion-no-violenta.pdf',
 'Documento en PDF con pasos claros para expresar necesidades sin atacar ni defenderse, fomentando empatía en los conflictos.',
 1),

('Video: El poder de la gratitud cotidiana',
 'video',
 'https://www.youtube.com/watch?v=2fL9JdG8LFA',
 'Video corto que muestra cómo el hábito de agradecer transforma la percepción diaria y fortalece la paz interior.',
 1),

('Ejercicio de diario: Conectando con mi propósito',
 'reflection',
 'https://miwebpaz.org/descargas/diario-proposito.pdf',
 'Plantilla descargable para reflexionar sobre tus valores, motivaciones y propósito personal. Ideal para fortalecer la autoconciencia.',
 1);


START TRANSACTION;

INSERT INTO questionnaires
  (title, description, category, total_questions, is_active)
VALUES
  (
    'Autoevaluación de la Paz Interior',
    'Evalúa tu conexión con el presente, tus niveles de estrés, tus tendencias ante conflictos y tu conexión con sentido y gratitud.',
    'general_wellbeing',
    20,
    TRUE
  );

SET @qid := LAST_INSERT_ID();

SET @likert := JSON_ARRAY(
  JSON_OBJECT('text','Totalmente en desacuerdo','value',1,'score',1),
  JSON_OBJECT('text','En desacuerdo','value',2,'score',2),
  JSON_OBJECT('text','Neutral','value',3,'score',3),
  JSON_OBJECT('text','De acuerdo','value',4,'score',4),
  JSON_OBJECT('text','Totalmente de acuerdo','value',5,'score',5)
);

INSERT INTO questions
(id_questionnaire, question_text, question_type, options, weight, question_order, dimension)
VALUES
(@qid, '¿Esta semana me he sentido realmente presente, sin estar rumiando sobre el pasado o ansioso por el futuro?', 'likert_scale', @likert, 1.00, 1,  'emotional'),
(@qid, 'Cuando surge una emoción difícil (tristeza, enfado, frustración), ¿puedo observarla sin juzgarme y permitir que pase, o tiendo a quedarme atrapado en ella?', 'likert_scale', @likert, 1.00, 2,  'emotional'),
(@qid, '¿Soy consciente de las señales físicas de mi cuerpo (tensión muscular, respiración acelerada, nudo en el estómago) que indican mi estado emocional?', 'likert_scale', @likert, 1.00, 3,  'emotional'),
(@qid, '¿Con qué facilidad puedo encontrar momentos de calma y silencio interior durante mi día, incluso en medio del ajetreo?', 'likert_scale', @likert, 1.00, 4,  'emotional'),
(@qid, '¿Mi estado de ánimo general se siente estable y sereno, o es como una montaña rusa de altibajos?', 'likert_scale', @likert, 1.00, 5,  'emotional');

INSERT INTO questions
(id_questionnaire, question_text, question_type, options, weight, question_order, dimension)
VALUES
(@qid, 'Al final del día, ¿suelo sentirme agotado física y mentalmente, o aún me queda una reserva de energía tranquila?', 'likert_scale', @likert, 1.00, 6,  'stress'),
(@qid, '¿Cómo manejo las situaciones imprevistas o los cambios de planes? ¿Reacciono con irritación y resistencia o con flexibilidad y aceptación?', 'likert_scale', @likert, 1.00, 7,  'stress'),
(@qid, '¿Mis pensamientos suelen ser acelerados, repetitivos y centrados en las preocupaciones?', 'likert_scale', @likert, 1.00, 8,  'stress'),
(@qid, '¿Dedico tiempo conscientemente a actividades que me recargan (leer, pasear en la naturaleza, un hobby, no hacer nada) o priorizo siempre la productividad?', 'likert_scale', @likert, 1.00, 9,  'stress'),
(@qid, '¿La calidad de mi sueño es reparadora, o tengo dificultades para conciliar el sueño porque mi mente no para?', 'likert_scale', @likert, 1.00, 10, 'stress');

INSERT INTO questions
(id_questionnaire, question_text, question_type, options, weight, question_order, dimension)
VALUES
(@qid, 'Cuando tengo un desacuerdo con alguien, ¿mi primer impulso es atacar/defenderme, huir de la situación, o puedo escuchar con curiosidad y expresarme con calma?', 'likert_scale', @likert, 1.00, 11, 'conflict'),
(@qid, '¿Con qué frecuencia me critico o me juzgo con dureza por mis errores? ¿Puedo practicar la autocompasión?', 'likert_scale', @likert, 1.00, 12, 'conflict'),
(@qid, '¿Siento que guardo resentimientos o rencores del pasado que pesan en mi presente?', 'likert_scale', @likert, 1.00, 13, 'conflict'),
(@qid, '¿Tiendo a asumir la responsabilidad de cosas que no me corresponden (estados de ánimo de otros, resultados que no controlo)?', 'likert_scale', @likert, 1.00, 14, 'conflict'),
(@qid, '¿Puedo establecer límites saludables sin sentirme culpable, diciendo "no" cuando es necesario para mi bienestar?', 'likert_scale', @likert, 1.00, 15, 'conflict');

INSERT INTO questions
(id_questionnaire, question_text, question_type, options, weight, question_order, dimension)
VALUES
(@qid, '¿Con qué frecuencia practico la gratitud, reconociendo conscientemente las cosas, por pequeñas que sean, que están bien en mi vida?', 'likert_scale', @likert, 1.00, 16, 'self_awareness'),
(@qid, '¿Siento que mis acciones y mi día a día están alineados con mis valores y con lo que es realmente importante para mí?', 'likert_scale', @likert, 1.00, 17, 'self_awareness'),
(@qid, '¿Me comparo frecuentemente con los demás (en lo personal, profesional, social), generando sentimientos de insuficiencia o envidia?', 'likert_scale', @likert, 1.00, 18, 'self_awareness'),
(@qid, '¿Soy capaz de soltar la necesidad de controlar cada aspecto de mi vida y confío en que las cosas se resolverán como deban?', 'likert_scale', @likert, 1.00, 19, 'self_awareness'),
(@qid, 'En general, ¿siento una sensación de confianza y fe (no necesariamente religiosa) en la vida y en mi capacidad para manejar lo que venga?', 'likert_scale', @likert, 1.00, 20, 'self_awareness');

COMMIT;
